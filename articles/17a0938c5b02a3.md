---
title: "useEffectEventé–¢æ•°ã¯ã€useEffectã®ä¾å­˜é…åˆ—ã«å«ã‚ã¦ã¯ã„ã‘ãªã„"
emoji: "ğŸ“š"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["React", "TypeScript", "useEffect", "useEffectEvent"]
published: true
---

# ã¯ã˜ã‚ã«

ã“ã¡ã‚‰ã‚’è³‡æ–™ã«è¿½è¨˜ã—ãŸã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚

https://speakerdeck.com/maguroalternative/react19-dot-2nouseeffecteventwozhui-u

é–“é•ã£ãŸæƒ…å ±ã‚’è¨˜è¼‰ã—ã¦ã—ã¾ã£ã¦ã„ãŸã®ã§è‡ªçœã‚’è¾¼ã‚ã¦æ›¸ã„ã¦ã¾ã™ã€‚
ã“ã®è¨˜äº‹ã‚‚è§£é‡ˆé–“é•ã£ã¦ã„ãŸã‚‰ã”æŒ‡æ‘˜ã„ãŸã ã‘ã‚‹ã¨å¹¸ã„ã§ã™ã€‚

https://twitter.com/sigumataityouda/status/1979173036151464031

# React19.2ãŒãƒªãƒªãƒ¼ã‚¹

2025/10/1ã«React19.2ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¾ã—ãŸã€‚

https://react.dev/blog/2025/10/01/react-19-2

ä¸­ã§ã‚‚æ–°ã—ã„hooksã§ã‚ã‚‹`useEffectEvent`ãŒè¿½åŠ ã•ã‚Œã€ã€Œstale closureå•é¡Œã€ã«ãƒ¡ã‚¹ãŒå…¥ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

# stale closureå•é¡Œ

ç°¡å˜ã«è¨€ãˆã°ã€ã€Œå¤ã„çŠ¶æ…‹ã‚’å‚ç…§ã—ç¶šã‘ã‚‹ã€ã“ã¨ã‚’æŒ‡ã—ã¾ã™ã€‚
ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹ã¨ã—ã¾ã™ã€‚

```tsx
export function Example() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    console.log("add listener")
    const handler = () => {
      console.log(count); // â† ã“ã“ãŒã€Œå¤ã„å€¤ã€ã«ãªã‚‹
    };
    window.addEventListener('click', handler);
    return () => window.removeEventListener('click', handler);
  }, []);
  
  return <button onClick={() => setCount(c => c + 1)}>+1</button>;
}
```

:::message alert
ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã¯`useEffect`ãªã—ã§å®Ÿè£…å¯èƒ½ã§ã™ãŒã€ä»Šå›ã¯ã‚ãˆã¦`useEffect`ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
:::

å†…å®¹ã¨ã—ã¦ã¯ã€Œã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã‚‹ãŸã³ã«`count`ã‚’`console`ã«è¡¨ç¤ºã™ã‚‹ã€ã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚
`button`ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨`count`ãŒã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã•ã‚Œã¾ã™ã€‚
ä¸€è¦‹ã€ä½•ã‚‰å•é¡Œãªã„ã‚ˆã†ã«è¦‹ãˆã¾ã™ãŒã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’è¦—ãã¨ã€ã€ã€

![](https://storage.googleapis.com/zenn-user-upload/95d36289b145-20251031.png)

ã¯ã„ã€‚`count`ãŒ0ã®ã¾ã¾ã§ã™ã€‚
ã“ã‚Œã¯`useEffect`å†…ã§ã®`count`ãŒã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ç™»éŒ²æ™‚ã®ã‚‚ã®ã‚’å‚ç…§ã—ç¶šã‘ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚
ã“ã®çŠ¶æ…‹ã‚’ã€Œstale closureå•é¡Œã€ã¨è¨€ã„ã¾ã™ã€‚

ä¸€å¿œã®è§£æ±ºç­–ã¨ã—ã¦ã¯ã€`useEffect`ã®ä¾å­˜é…åˆ—ã«`count`ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãªã®ã§ã™ãŒã€ã“ã‚Œã¯ã“ã‚Œã§åˆ¥ã®å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚

```tsx
export function Example() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    console.log("add listener")
    const handler = () => {
      console.log(count); // â† ã“ã“ãŒã€Œå¤ã„å€¤ã€ã«ãªã‚‹
    };
    window.addEventListener('click', handler);
    return () => window.removeEventListener('click', handler);
  }, [count]);
  
  return <button onClick={() => setCount(c => c + 1)}>+1</button>;
}
```

ã“ã‚Œã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è¦—ãã¨

![](https://storage.googleapis.com/zenn-user-upload/431ef1944cc7-20251031.png)

`count`ã¯æ›´æ–°ã§ãã¾ã—ãŸãŒã€æ–°ãŸã«ã€Œadd listenerã€ã®è¡¨ç¤ºãŒæ¯å›ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
ã“ã‚Œã¯`count`ãŒæ›´æ–°ã•ã‚Œã‚‹ãŸã³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²ã—ã¦ã„ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ä¸­èº«ã®`count`ã¯ãã®åº¦ã«æœ€æ–°ã®ã‚‚ã®ã«ãªã‚Šã¾ã™ãŒã€ã‚ã–ã‚ã–ãã®ãŸã‚ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†ç™»éŒ²ã™ã‚‹ã®ã¯ä½™åˆ†ã§ã™ã€‚

æœ€æ–°ã®`count`ã‚’å‚ç…§ã•ã›ãŸã„ãŒã€ã„ã¡ã„ã¡ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†ç™»éŒ²ã•ã›ãŸããªã„ã€ã€ã€ãã‚“ãªæ™‚ã«ã“ã`useEffectEvent`ã®å‡ºç•ªã§ã™ã€‚

```tsx
export function Example() {
  const [count, setCount] = useState(0);

  const handlerClick = useEffectEvent(() => {
    console.log(count);
  })

  useEffect(() => {
    console.log("add listener")
    window.addEventListener('click', handlerClick);
    return () => window.removeEventListener('click', handlerClick);
  }, []);
  
  return <button onClick={() => setCount(c => c + 1)}>+1</button>;
}
```

`useEffectEvent`ã‚’`handler`ã¨ã—ã¦æ–°ãŸã«å®šç¾©ã—ã¾ã™ã€‚
å‰ã¨ç•°ãªã‚‹ç‚¹ã¨ã—ã¦ã€`useEffect`ã®ä¾å­˜é…åˆ—ãŒç©ºã«ãªã£ã¦ã„ã¾ã™ã€‚
ä¾å­˜é–¢ä¿‚ãŒãªã„ã®ã§ã€åˆå›ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒç™»éŒ²ã•ã‚Œã‚‹ã ã‘ã«ãªã‚Šã¾ã™ã€‚

ãã†ãªã‚‹ã¨å…ˆã»ã©ã¨åŒã˜ã`count`ã®å€¤ã¯æ›´æ–°ã•ã‚Œãªã„ã¾ã¾ã¨æ€ã„ãã‚„ã€ã€ã€ï¼Ÿ

![](https://storage.googleapis.com/zenn-user-upload/467de2ee1179-20251031.png)

ã¯ã„ã€æ›´æ–°ã•ã‚Œã¦ã„ã¾ã™ã€‚
ãã†ã€`useEffectEvent`ã¯å¸¸ã«æœ€æ–°ã®çŠ¶æ…‹ã®`state`ã‚’å–å¾—ã—ã¦ãã‚Œã‚‹ã®ã§ã™ã€‚

# useEffectEventã¯ä¾å­˜é…åˆ—ã«å«ã¾ã‚Œãªã„ï¼Ÿ

ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¦ã€é•å’Œæ„Ÿã‚’æŒã£ãŸæ–¹ã‚‚ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚
`useEffectEvent`ã®é–¢æ•°ã‚’`useEffect`ã®ä¾å­˜é…åˆ—ã«å«ã‚ã¦ã„ãªã„ã®ã§ã™ã€‚

å®Ÿéš›ã€linter[^1]ã‚‚è­¦å‘Šã‚’å‡ºã—ã¦ãã‚Œã¦ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/e7c4e02318d3-20251031.png)

![](https://storage.googleapis.com/zenn-user-upload/47fc1f864b4d-20251031.png)


ãªã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ä¾å­˜é…åˆ—ã«å«ã‚ã‚‹ã®ãŒæ­£ã‹ã¨æ€ã„ãã‚„ã€ã€ã€

```tsx
useEffect(() => {
  console.log("add listener useEffectEvent")
  window.addEventListener("click", handleClick);
  return () => window.removeEventListener("click", handleClick);
}, [handleClick]);
```

![](https://storage.googleapis.com/zenn-user-upload/eb5ae2189eb7-20251031.png)

ã¯ã„ã€ãªã‚“ã¨**ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒå†ç™»éŒ²ã•ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚**
ã“ã‚Œã¯`handleClick`ãŒæ¯å›ç•°ãªã‚‹é–¢æ•°ã‚’è¿”ã™ã¨è¨€ã†æ„å‘³ã«ã‚‚ãªã‚Šã€å ´åˆã«ã‚ˆã£ã¦ã¯ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’å¼•ãèµ·ã“ã™ã“ã¨ã«ã‚‚ãªã‚Šã¾ã™ã€‚

## ãªã‚“ã§ã“ã‚“ãªã“ã¨ã«ï¼Ÿ

ä»¥ä¸‹ã®PRã«è©³ç´°ãŒã‚ã‚Šã¾ã™ã€‚

https://github.com/facebook/react/pull/25473

`useEffect`ã¯å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã¨åŒæœŸã‚’è¡Œã†å½¹å‰²ã‚’æŒã¤ãŸã‚ã€å†…éƒ¨ã§ä½¿ç”¨ã™ã‚‹å€¤ã‚„é–¢æ•°ã¯ä¾å­˜é…åˆ—ã«å«ã‚ã‚‹ã“ã¨ãŒå‰æã«ãªã£ã¦ã„ã¾ã™ã€‚
`linter`ãŒè­¦å‘Šã‚’å‡ºã™ã®ã¯ãã®ãŸã‚ã§ã€stale closureå•é¡Œã‚’å¼•ãèµ·ã“ã™ã®ã‚’é˜²ãå½¹å‰²ã‚’æŒã¡ã¾ã™ã€‚

ã—ã‹ã—`useEffectEvent`ã¯æœ€æ–°ã®çŠ¶æ…‹ã‚’æŒã¤ã“ã¨ã‚’ä¿è¨¼ã—ã¦ãã‚Œã‚‹hooksã§ã™ã€‚
å¸¸ã«æœ€æ–°ã®çŠ¶æ…‹ã‚’æŒã£ã¦ãã‚Œã‚‹ã®ã«ã€ä¾å­˜é…åˆ—ã«å«ã‚ã‚‹ã“ã¨ã¯ãŠã‹ã—ã„ã®ã§ã¯ãªã„ã‹ï¼Ÿ

ãã®ãŸã‚æ„å›³çš„ã«`useEffectEvent`ã¯æ¯å›ç•°ãªã‚‹é–¢æ•°ã‚’è¿”ã™å®Ÿè£…ã«ãªã£ãŸãã†ã§ã™ã€‚

:::details ã‚‚ã†ã¡ã‚‡ã„è£œè¶³
å½“åˆã¯æ¯å›æ–°ã—ã„é–¢æ•°ã‚’è¿”ã™å®Ÿè£…ã§ã¯ãªã‹ã£ãŸã‚ˆã†ã§ã™ã€‚
ã—ã‹ã—ãã®å ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ãªçŠ¶æ…‹ãŒèµ·ã“ã‚Šãˆã¾ã™ã€‚

- ä¾å­˜é…åˆ—ã‚ã‚Š
```tsx
  const handleClick = useEffectEvent(() => {
    console.log("æœ€æ–°ã® count:", count);
  });

  useEffect(() => {
    console.log("add listener useEffectEvent")
    window.addEventListener("click", handleClick);
    return () => window.removeEventListener("click", handleClick);
  }, [handleClick]);
```

- ä¾å­˜é…åˆ—ãªã—
```tsx
  const handleClick = useEffectEvent(() => {
    console.log("æœ€æ–°ã® count:", count);
  });

  useEffect(() => {
    console.log("add listener useEffectEvent")
    window.addEventListener("click", handleClick);
    return () => window.removeEventListener("click", handleClick);
  }, []);
```

ã“ã®2ã¤ã®ã‚³ãƒ¼ãƒ‰ãŒ**å…¨ãåŒã˜æŒ™å‹•ã‚’ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚**

`useEffectEvent`ã®é–¢æ•°ãŒå¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ãªã®ã‹å¦ã‹ãŒæ›–æ˜§ã«ãªã‚Šã€Reactã®æ€æƒ³ã¨ã—ã¦ã‚ˆã‚ã—ããªã„çŠ¶æ…‹ã«ãªã£ã¦ã„ã¾ã™ã€‚

ãªã®ã§ã‚ãˆã¦æ–°ã—ã„é–¢æ•°ã‚’è¿”ã™ã“ã¨ã«ã‚ˆã£ã¦ã€å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ãªã„ã“ã¨ã‚’ç¤ºã™å®Ÿè£…ã«ãªã£ãŸã‚‰ã—ã„ã§ã™ã€‚
:::

# ã¾ã¨ã‚

ã¨ã‚Šã‚ãˆãšã“ã‚Œã ã‘è¦šãˆã¦ãŠã„ã¦ãã ã•ã„ã€‚
- `useEffectEvent`é–¢æ•°ã¯ã€(`useEffect`ã®å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ã«è©²å½“ã—ãªã„ãŸã‚)`useEffect`ã®ä¾å­˜é…åˆ—ã«å«ã‚ã¦ã¯ã„ã‘ãªã„ã€‚
- linterã®æ›´æ–°ã‚‚å¿˜ã‚Œãšã«ã€ã€ã€ã€
  - linterã«é¨™ã•ã‚ŒãŸã¨è¨€ã£ã¦ã¾ã™ãŒã€å˜ç´”ã«linterã‚’æ›´æ–°ã—ã¦ãªã„è‡ªåˆ†ã®ã›ã„ã§ã™ã€ã€ã€

https://twitter.com/sigumataityouda/status/1979469752784593164


[^1]: æœ€æ–°ã®linterã¯è­¦å‘Šã‚’å‡ºã•ãªã„ã‚ˆã†ã§ã™ã€‚
