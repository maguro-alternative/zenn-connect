---
title: "useEffectEvent関数は、useEffectの依存配列に含めてはいけない"
emoji: "📚"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

# はじめに

こちらを記事にしたものになります。

https://speakerdeck.com/maguroalternative/react19-dot-2nouseeffecteventwozhui-u

# React19.2がリリース

2025/10/1にReact19.2がリリースされました。

https://react.dev/blog/2025/10/01/react-19-2

中でも新しいhooksである`useEffectEvent`が追加され、「stale closure問題」にメスが入るようになりました。

# stale closure問題

簡単に言えば、「古い状態を参照し続ける」ことを指します。
例えば以下のコードがあるとします。

```tsx
export function Example() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    console.log("add listener")
    const handler = () => {
      console.log(count); // ← ここが「古い値」になる
    };
    window.addEventListener('click', handler);
    return () => window.removeEventListener('click', handler);
  }, []);
  
  return <button onClick={() => setCount(c => c + 1)}>+1</button>;
}
```

内容としては「クリックされるたびにcountをconsoleに表示する」ものになります。
buttonをクリックするとcountがインクリメントされます。
一見、何ら問題ないように見えますが、コンソールを覗くと、、、



はい。countが0のままです。
これはuseEffect内でのcountがイベントハンドラ登録時のものを参照し続けているためです。
この状態を「stale closure問題」と言います。

一応の解決策としては、useEffectの依存配列にcountを追加することなのですが、これはこれで別の問題があります。

```tsx
export function Example() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    console.log("add listener")
    const handler = () => {
      console.log(count); // ← ここが「古い値」になる
    };
    window.addEventListener('click', handler);
    return () => window.removeEventListener('click', handler);
  }, [count]);
  
  return <button onClick={() => setCount(c => c + 1)}>+1</button>;
}
```

これをコンソールで覗くと


countは更新できましたが、新たに「add listener」の表示が毎回されるようになりました。
これはcountが更新されるたびにイベントリスナーを登録していることになります。中身のcountはその度に最新のものになりますが、わざわざそのためにイベントリスナーを再登録するのは余分です。

最新のcountを参照させたいが、いちいちイベントハンドラを再登録させたくない、、、そんな時にこそ`useEffectEvent`の出番です。

```tsx
export function Example() {
  const [count, setCount] = useState(0);

  const handlerClick = useEffectEvent(() => {
    console.log(count);
  })

  useEffect(() => {
    console.log("add listener")
    window.addEventListener('click', handlerClick);
    return () => window.removeEventListener('click', handlerClick);
  }, []);
  
  return <button onClick={() => setCount(c => c + 1)}>+1</button>;
}
```
