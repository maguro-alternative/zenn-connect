---
title: "Drizzleã§Honoã®DBãƒ†ã‚¹ãƒˆç”¨ã®ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ä½œæˆ"
emoji: "ğŸ’¨"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Nextjs", "Hono", "Drizzle"]
published: false
---

# æ³¨æ„
ãŸã ä½œæˆã¨ã„ã£ã¦ã‚‚ä»¥ä¸‹ã®ã‚‚ã®ã‚’Drizzleç”¨ã«ç§»æ¤ã—ãŸã‚‚ã®ã«ãªã‚Šã¾ã™ã€‚

https://engineering.mercari.com/blog/entry/20220411-42fc0ba69c/

# ã¯ã˜ã‚ã«
ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆã‚’æ›¸ãéš›ã€ã‚ã‚‰ã‹ã˜ã‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹ã‚’ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã¨ã—ã¦æº–å‚™ã—ã€ãƒ†ã‚¹ãƒˆã‚’è¡Œã†ã¨ã„ã†ã®ã‚’ã‚ˆãã‚„ã‚Šã¾ã™ã€‚
```Rails```ã‚„```Django```ãªã©ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ã¯å¿…ãšã¨è¨€ã£ã¦è‰¯ã„ã»ã©å…¥ã£ã¦ãŠã‚Šã€éå¸¸ã«åŠ©ã‹ã‚Šã¾ã™ã€‚

ã§ã™ãŒHonoã§ã®DBãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã®ãƒ†ã‚¹ãƒˆã®æ–¹æ³•ã‚’æ¢ã—ã¦ã‚‚(è¦³æ¸¬ã—ãŸç¯„å›²ã§ã¯)è¦‹ã¤ã‹ã‚‰ãšã€ã ã£ãŸã‚‰ä½œã£ã¦ã—ã¾ãŠã†ã‹ã¨ãªã‚Šä½œæˆã—ã¾ã—ãŸã€‚
å‚™å¿˜éŒ²ã¨ã—ã¦è¨˜äº‹ã«ã—ã¦ã„ã¾ã™ã€‚

ã‚³ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ãŠã„ã¦ã„ã¾ã™ã€‚

https://github.com/maguro-alternative/hono-next-test-sample

# å‰æ
åˆ©ç”¨ã™ã‚‹ã‚‚ã®ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚
- ãƒ©ã‚¤ãƒ–ãƒ©ãƒª
  - Hono
  - Drizzle
  - Next.js
  - jest
  - postgres
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
  - PostgreSQL

Postgresã§ä»¥ä¸‹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’åˆ©ç”¨ã—ãŸTodoã‚¢ãƒ—ãƒªã‚’ä¾‹ã¨ã—ã¦è©±ã—ã¾ã™ã€‚

:::details drizzleã§ã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
```ts:schema.ts
import { integer, serial } from 'drizzle-orm/pg-core';
import {
  timestamp,
  pgTable,
  text,
  boolean,
} from 'drizzle-orm/pg-core';

export const todos = pgTable('todos', {
  id: serial().primaryKey().notNull(),
  name: text().notNull(),
  done: boolean().notNull(),
  created_at: timestamp(),
  updated_at: timestamp(),
});

export const assignees = pgTable('assignees', {
  todoId: integer().primaryKey().references(() => todos.id),
  name: text().notNull(),
  created_at: timestamp(),
  updated_at: timestamp(),
});
```
:::

:::details ãƒ†ãƒ¼ãƒ–ãƒ«
```
postgres=# \d+ public.todos
                                                            ãƒ†ãƒ¼ãƒ–ãƒ«"public.todos"
     åˆ—     |           ã‚¿ã‚¤ãƒ—            | ç…§åˆé †åº | Null å€¤ã‚’è¨±å®¹ |            ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ             | ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ | åœ§ç¸® | çµ±è¨ˆç›®æ¨™ | èª¬æ˜ 
------------+-----------------------------+----------+---------------+-----------------------------------+------------+------+----------+------
 id         | integer                     |          | not null      | nextval('todos_id_seq'::regclass) | plain      |      |          | 
 name       | text                        |          | not null      |                                   | extended   |      |          | 
 done       | boolean                     |          | not null      |                                   | plain      |      |          | 
 created_at | timestamp without time zone |          |               |                                   | plain      |      |          | 
 updated_at | timestamp without time zone |          |               |                                   | plain      |      |          | 
ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:
    "todos_pkey" PRIMARY KEY, btree (id)
å‚ç…§å…ƒ:
    TABLE "assignees" CONSTRAINT "assignees_todoId_todos_id_fk" FOREIGN KEY ("todoId") REFERENCES todos(id)
ã‚¢ã‚¯ã‚»ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰: heap

postgres=# \d+ public.assignees
                                               ãƒ†ãƒ¼ãƒ–ãƒ«"public.assignees"
     åˆ—     |           ã‚¿ã‚¤ãƒ—            | ç…§åˆé †åº | Null å€¤ã‚’è¨±å®¹ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ | åœ§ç¸® | çµ±è¨ˆç›®æ¨™ | èª¬æ˜ 
------------+-----------------------------+----------+---------------+------------+------------+------+----------+------
 todoId     | integer                     |          | not null      |            | plain      |      |          | 
 name       | text                        |          | not null      |            | extended   |      |          | 
 created_at | timestamp without time zone |          |               |            | plain      |      |          | 
 updated_at | timestamp without time zone |          |               |            | plain      |      |          | 
ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:
    "assignees_pkey" PRIMARY KEY, btree ("todoId")
å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„:
    "assignees_todoId_todos_id_fk" FOREIGN KEY ("todoId") REFERENCES todos(id)
ã‚¢ã‚¯ã‚»ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰: heap

postgres=#
```

:::

MySQLã§ã‚‚å•é¡Œãªãå‹•ãã¯ãšã§ã™ã€‚

# ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã¨ã¯ï¼Ÿ
CakePHPã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚ã‹ã‚Šã‚„ã™ã„è¡¨ç¾ã‚’ã—ã¦ã„ãŸã®ã§å¼•ç”¨ã—ã¾ã™ã€‚

https://book.cakephp.org/4/ja/development/testing.html#:~:text=%E3%81%AA%E3%82%8A%E3%81%BE%E3%81%9B%E3%82%93%E3%80%82-,%E3%83%95%E3%82%A3%E3%82%AF%E3%82%B9%E3%83%81%E3%83%A3%E3%83%BC,%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E3%82%92%E7%A9%BA%E3%81%AB%E3%81%97%E3%81%BE%E3%81%99%E3%80%82

> ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®æŒ™å‹•ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚„ãƒ¢ãƒ‡ãƒ«ã«ä¾å­˜ã™ã‚‹ã¨ãã€ãƒ†ã‚¹ãƒˆã«ä½¿ã†ãŸã‚ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”Ÿæˆã—ã€ ä¸€æ™‚çš„ãªãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãŸã‚ã« ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ãƒ¼ ã‚’ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚ ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ãƒ¼ã‚’ä½¿ã†ã“ã¨ã«ã‚ˆã‚Šã€ å®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ä½¿ã‚ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ç ´å£Šã™ã‚‹ã“ã¨ãªã ãƒ†ã‚¹ãƒˆãŒã§ãã‚‹ã¨ã„ã†ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚ ã¾ãŸã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å®Ÿéš›ã«ç”¨æ„ã™ã‚‹ã‚ˆã‚Š å…ˆã«ã‚³ãƒ¼ãƒ‰ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ã“ã‚Œã«ã‚ˆã‚Šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã‚„ã€ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®æŒ™å‹•ã‚’ãƒ†ã‚¹ãƒˆã§å†ç¾ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

# ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã®æµã‚Œ
```fixtures.ts```ã¨ãã‚Œãã‚Œã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾å¿œã™ã‚‹```assignee.ts```ã¨```todo.ts```ã‚’ä½œæˆã—ã¾ã™ã€‚
```
.
â”œâ”€â”€ fixture
â”‚   â”œâ”€â”€ assignee.ts
â”‚   â”œâ”€â”€ fixtures.ts
â”‚   â””â”€â”€ todo.ts
```

:::details assignee.ts

https://github.com/maguro-alternative/hono-next-test-sample/blob/main/fixtures/assignee.ts

:::

:::details todo.ts

https://github.com/maguro-alternative/hono-next-test-sample/blob/main/fixtures/todo.ts

:::

## fixtures.ts

https://github.com/maguro-alternative/hono-next-test-sample/blob/main/fixtures/fixtures.ts

ModelConnectorã‚¯ãƒ©ã‚¹ã§ãƒ¢ãƒ‡ãƒ«ã®ç®¡ç†ã‚„ã€ä»–ã®ãƒ¢ãƒ‡ãƒ«ã¨æ¥ç¶šã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æŒ¿å…¥ã™ã‚‹ãŸã‚ã®ã‚¯ãƒ©ã‚¹ã§ã™ã€‚

ãã‚Œãã‚Œã®å¼•æ•°ã«
```model```: ãƒ¢ãƒ‡ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚```todo```ã‚„```assignee```ã®ãƒ†ãƒ¼ãƒ–ãƒ«é–¢é€£ã®ãƒ¢ãƒ‡ãƒ«ã‚’å…¥ã‚Œã‚‹ã€‚
```setter```: ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸå€¤ã‚’è¨­å®šã™ã‚‹é–¢æ•°ã€‚
```addToFixture```: ```setter```ã§è¨­å®šã—ãŸåˆæœŸå€¤ã‚’ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã«ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°ã€‚
```connect```: ä»–ã®ãƒ¢ãƒ‡ãƒ«ã¨æ¥ç¶šã™ã‚‹é–¢æ•°ã€‚
```insertTable```: ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æŒ¿å…¥ã™ã‚‹éåŒæœŸé–¢æ•°ã€‚
```connectWith```: ä»–ã®ModelConnectorã¨æ¥ç¶šã—ã¾ã™ã€‚
```addToFixtureAndConnect```: ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã«ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ã—ã€æ¥ç¶šã™ã‚‹éåŒæœŸé–¢æ•°ã€‚

# ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã®ä½¿ã„æ–¹
todoä¸€è¦§ã‚’å–å¾—ã—ã€jsonã‚’è¿”ã™APIãŒã‚ã‚Šã¾ã™ã€‚

https://github.com/maguro-alternative/hono-next-test-sample/blob/main/app/api/%5B%5B...route%5D%5D/todo.ts

ã“ã®todoã®å–å¾—ã®ãƒ†ã‚¹ãƒˆã‚’ã—ã¦ã¿ã¾ã™ã€‚

https://github.com/maguro-alternative/hono-next-test-sample/blob/main/app/api/%5B%5B...route%5D%5D/todo.test.ts

- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¼µã‚Šã€ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‚’ä½œæˆã—ã¾ã™ã€‚

https://github.com/maguro-alternative/hono-next-test-sample/blob/e62dd9df1c8f4184250f29c9ce6d88f10618f3c1/app/api/%5B%5B...route%5D%5D/todo.test.ts#L15-L16

- ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã«ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ ã—ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã«æŒ¿å…¥ã—ã¾ã™ã€‚

https://github.com/maguro-alternative/hono-next-test-sample/blob/e62dd9df1c8f4184250f29c9ce6d88f10618f3c1/app/api/%5B%5B...route%5D%5D/todo.test.ts#L17-L24

- requestãƒ¡ã‚½ãƒƒãƒ‰ã§Getãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

https://github.com/maguro-alternative/hono-next-test-sample/blob/e62dd9df1c8f4184250f29c9ce6d88f10618f3c1/app/api/%5B%5B...route%5D%5D/todo.test.ts#L25-L27

- 200ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã¨æœŸå¾…ã—ãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒå¸°ã£ã¦ãã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚

https://github.com/maguro-alternative/hono-next-test-sample/blob/e62dd9df1c8f4184250f29c9ce6d88f10618f3c1/app/api/%5B%5B...route%5D%5D/todo.test.ts#L28-L39
